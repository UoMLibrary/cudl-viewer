// Generated by CoffeeScript 1.6.3
/*
                       __  .__              ________ 
   ______ ____   _____/  |_|__| ____   ____/   __   \
  /  ___// __ \_/ ___\   __\  |/  _ \ /    \____    /
  \___ \\  ___/\  \___|  | |  (  <_> )   |  \ /    / 
 /____  >\___  >\___  >__| |__|\____/|___|  //____/  .co.uk
      \/     \/     \/                    \/         
                                              Equatorie
                                              Benjamin Blundell - ben@section9.co.uk
                                              http://www.section9.co.uk
*/


(function() {
  var CoffeeGL, Equatorie, EquatorieInteract, EquatorieString, EquatorieSystem, cgl, eq, loadAssets,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  CoffeeGL = require('../lib/coffeegl/coffeegl').CoffeeGL;

  EquatorieSystem = require('./system').EquatorieSystem;

  EquatorieString = require('./string').EquatorieString;

  loadAssets = require('./load').loadAssets;

  EquatorieInteract = require('./interact').EquatorieInteract;

  Equatorie = (function() {
    function Equatorie() {
      this.draw = __bind(this.draw, this);
      this.onPhysicsEvent = __bind(this.onPhysicsEvent, this);
      this.update = __bind(this.update, this);
      this.init = __bind(this.init, this);
    }

    Equatorie.prototype.init = function() {
      var cube, cube_thin, date, f, sphere, tp,
        _this = this;
      f = function() {
        var h, w;
        w = $(window).width();
        h = $(window).height();
        $("#webgl-canvas").attr("width", w);
        $("#webgl-canvas").attr("height", h);
        $("#webgl-canvas").width(w);
        $("#webgl-canvas").height(h);
        cgl.resize(w, h);
        return eq.resize(w, h);
      };
      $(window).bind("resize", f);
      $(window).bind("ready", f);
      this.top_node = new CoffeeGL.Node();
      this.depth_node = new CoffeeGL.Node();
      this.string_height = 0.2;
      this.string_nodes = new CoffeeGL.Node();
      this.pickable = new CoffeeGL.Node();
      this.fbo_picking = new CoffeeGL.Fbo();
      this.ray = new CoffeeGL.Vec3(0, 0, 0);
      this.fbo_fxaa = new CoffeeGL.Fbo();
      if (!CoffeeGL.Context.profile.mobile) {
        this.fbo_depth = new CoffeeGL.Fbo();
      }
      this.advance_date = 0;
      this.basic_nodes = new CoffeeGL.Node();
      this.mp = new CoffeeGL.Vec2(-1, -1);
      this.system = new EquatorieSystem();
      this.marker = new CoffeeGL.Node();
      this.marker.descend = false;
      this.ready = false;
      this.loaded = new CoffeeGL.Signal();
      this.load_progress = new CoffeeGL.Signal();
      if (typeof window !== "undefined" && window !== null) {
        window.EquatorieLoaded = this.loaded;
      }
      if (typeof window !== "undefined" && window !== null) {
        window.EquatorieLoadProgress = this.load_progress;
      }
      cube = new CoffeeGL.Shapes.Cuboid(new CoffeeGL.Vec3(0.2, 0.2, 0.2));
      sphere = new CoffeeGL.Node(new CoffeeGL.Shapes.Sphere(0.15, 12));
      cube_thin = new CoffeeGL.Node(new CoffeeGL.Shapes.Cuboid(new CoffeeGL.Vec3(0.01, 0.5, 0.01)));
      cube_thin.matrix.translate(new CoffeeGL.Vec3(0, -0.2, 0));
      sphere.matrix.translate(new CoffeeGL.Vec3(0, 0.1, 0));
      this.white_string = new EquatorieString(8, 0.03, 20);
      this.black_string = new EquatorieString(8, 0.03, 20);
      this.pin = new CoffeeGL.Node();
      this.pin.add(sphere);
      this.white_start = new CoffeeGL.Node;
      tp = this.pin.copy();
      tp.matrix = this.white_start.matrix;
      this.white_start.add(tp);
      this.pickable.add(tp);
      this.white_start.matrix.translate(new CoffeeGL.Vec3(2, this.string_height, 2));
      tp.uPickingColour = new CoffeeGL.Colour.RGBA(1.0, 0.0, 0.0, 1.0);
      this.white_end = new CoffeeGL.Node;
      tp = this.pin.copy();
      tp.matrix = this.white_end.matrix;
      this.white_end.add(tp);
      this.pickable.add(tp);
      this.white_end.matrix.translate(new CoffeeGL.Vec3(-2, this.string_height, -2));
      tp.uPickingColour = new CoffeeGL.Colour.RGBA(0.0, 1.0, 0.0, 1.0);
      this.black_start = new CoffeeGL.Node;
      tp = this.pin.copy();
      tp.matrix = this.black_start.matrix;
      this.black_start.add(tp);
      this.pickable.add(tp);
      this.black_start.matrix.translate(new CoffeeGL.Vec3(-2, this.string_height, 2));
      tp.uPickingColour = new CoffeeGL.Colour.RGBA(0.0, 0.0, 1.0, 1.0);
      this.black_end = new CoffeeGL.Node;
      tp = this.pin.copy();
      tp.matrix = this.black_end.matrix;
      this.black_end.add(tp);
      this.pickable.add(tp);
      this.black_end.matrix.translate(new CoffeeGL.Vec3(-4, this.string_height, 2));
      tp.uPickingColour = new CoffeeGL.Colour.RGBA(1.0, 1.0, 1.0, 1.0);
      this.string_nodes.add(this.white_string).add(this.black_string);
      this.white_string.uColour = new CoffeeGL.Colour.RGBA(0.9, 0.9, 0.9, 1.0);
      this.black_string.uColour = new CoffeeGL.Colour.RGBA(0.1, 0.1, 0.1, 1.0);
      this.white_start.uColour = new CoffeeGL.Colour.RGBA(0.9, 0.2, 0.2, 0.8);
      this.white_end.uColour = new CoffeeGL.Colour.RGBA(0.2, 0.2, 0.9, 0.8);
      this.black_start.uColour = new CoffeeGL.Colour.RGBA(0.9, 0.2, 0.2, 0.8);
      this.black_end.uColour = new CoffeeGL.Colour.RGBA(0.2, 0.2, 0.9, 0.8);
      this.c = new CoffeeGL.Camera.TouchPerspCamera(new CoffeeGL.Vec3(0, 0, 1), new CoffeeGL.Vec3(0, 0, 0), new CoffeeGL.Vec3(0, 1.0, 0.0), 55.0, 0.01, 30.0, 0.1);
      this.c.zoom_near = 0.8;
      this.c.zoom_far = 18.0;
      this.c.orbit(new CoffeeGL.Vec3(1, 0, 0), CoffeeGL.degToRad(-25));
      this.o = new CoffeeGL.Camera.OrthoCamera(new CoffeeGL.Vec3(0, 0, 0.1));
      f = function() {
        var child, q, tn, x, _i, _j, _len, _len1, _ref, _ref1;
        _this.top_node.add(_this.basic_nodes);
        _this.basic_nodes.shader = _this.shader_basic;
        _this.backing = new CoffeeGL.Node(new CoffeeGL.Quad());
        _this.string_nodes.shader = _this.shader_string;
        _this.base = _this.equatorie_model.children[4];
        _this.epicycle = _this.equatorie_model.children[1];
        _this.pointer = _this.equatorie_model.children[0];
        _this.rim = _this.equatorie_model.children[3];
        _this.plate = _this.equatorie_model.children[2];
        _this.shiny = new CoffeeGL.Node();
        _this.top_node.add(_this.shiny);
        _this.depth_node.add(_this.epicycle);
        _this.depth_node.add(_this.rim);
        _this.depth_node.add(_this.plate);
        _this.depth_node.add(_this.base);
        _this.depth_node.add(_this.shader_depth);
        _this._setTangents(_this.pointer.geometry);
        _this._setTangents(_this.epicycle.geometry);
        _this._setTangents(_this.rim.geometry);
        _this._setTangents(_this.plate.geometry);
        _this._setTangents(_this.base.geometry);
        _ref = _this.needle_model.children;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          child = _ref[_i];
          _this._setTangents(child.geometry);
        }
        _this.marker.add(_this.needle_model);
        _this.needle_model.matrix.translate(new CoffeeGL.Vec3(0, -_this.string_height, 0));
        _this.shiny_needles = new CoffeeGL.Node();
        _this.shiny_needles.uAmbientLightingColor = new CoffeeGL.Colour.RGBA(0.01, 0.01, 0.01, 1.0);
        _this.shiny_needles.uSpecColour = new CoffeeGL.Colour.RGBA(0.8, 0.8, 0.8, 1.0);
        _this.shiny_needles.uAlphaX = 0.1;
        _this.shiny_needles.uAlphaY = 0.5;
        _this.shiny_needles.add(_this.needle_normal);
        _this.shiny_needles.uSamplerNormal = 1;
        _this.shiny_needles.add(_this.shader_aniso);
        _this.shiny_needles.add(_this.marker);
        _ref1 = [_this.white_start, _this.white_end, _this.black_start, _this.black_end];
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          x = _ref1[_j];
          tn = new CoffeeGL.Node();
          tn.add(_this.needle_model);
          tn.matrix = x.matrix;
          x.add(tn);
          _this.shiny_needles.add(tn);
        }
        _this.top_node.add(_this.shiny_needles);
        _this.shiny.shader = _this.shader_aniso;
        _this.shiny.add(_this.epicycle);
        _this.shiny.add(_this.rim);
        _this.shiny.add(_this.plate);
        _this.shiny.add(_this.base);
        _this.pointer.add(_this.pointer_normal);
        _this.rim.add(_this.rim_normal);
        _this.plate.add(_this.plate_normal);
        _this.epicycle.add(_this.epicycle_normal);
        _this.base.add(_this.base_normal);
        _this.shiny.uSamplerNormal = 1;
        _this.base.uAmbientLightingColor = new CoffeeGL.Colour.RGBA(1.0, 1.0, 0.8, 1.0);
        _this.base.uSpecColour = new CoffeeGL.Colour.RGBA(0.5, 0.5, 0.5, 1.0);
        _this.base.uAlphaX = 0.05;
        _this.base.uAlphaY = 0.05;
        _this.epicycle.uAmbientLightingColor = new CoffeeGL.Colour.RGBA(0.1, 0.1, 0.1, 1.0);
        _this.epicycle.uSpecColour = new CoffeeGL.Colour.RGBA(1.0, 0.9, 0.8, 1.0);
        _this.epicycle.uAlphaX = 0.4;
        _this.epicycle.uAlphaY = 0.28;
        _this.pointer.uAmbientLightingColor = new CoffeeGL.Colour.RGBA(0.1, 0.1, 0.1, 1.0);
        _this.pointer.uSpecColour = new CoffeeGL.Colour.RGBA(1.0, 0.9, 0.9, 1.0);
        _this.pointer.uAlphaX = 0.2;
        _this.pointer.uAlphaY = 0.1;
        _this.epicycle.uPickingColour = new CoffeeGL.Colour.RGBA(1.0, 1.0, 0.0, 1.0);
        _this.pointer.uPickingColour = new CoffeeGL.Colour.RGBA(0.0, 1.0, 1.0, 1.0);
        _this.pickable.add(_this.epicycle);
        _this.equatorie_model.remove(_this.pointer);
        _this.epicycle.add(_this.pointer);
        q = new CoffeeGL.Quaternion();
        q.fromAxisAngle(new CoffeeGL.Vec3(0, 1, 0), CoffeeGL.degToRad(-90.0));
        _this.base.matrix.mult(q.getMatrix4());
        _this.pickable.shader = _this.shader_picker;
        _this.top_node.add(_this.basic_nodes);
        _this.basic_nodes.shader = _this.shader_basic;
        _this.physics = new Worker('/js/physics.js');
        _this.physics.onmessage = _this.onPhysicsEvent;
        _this.physics.postMessage({
          cmd: "startup"
        });
        _this.interact = new EquatorieInteract(_this.system, _this.physics, _this.c, _this.white_start, _this.white_end, _this.black_start, _this.black_end, _this.epicycle, _this.pointer, _this.marker, _this.plate, _this.string_height);
        _this.interact.setDate(new Date("December 31, 1392 12:00:00"));
        if (typeof window !== "undefined" && window !== null) {
          window.Equatorie = eq.interact;
        }
        CoffeeGL.Context.mouseDown.add(_this.interact.onMouseDown, _this.interact);
        CoffeeGL.Context.mouseOver.add(_this.interact.onMouseOver, _this.interact);
        CoffeeGL.Context.mouseOut.add(_this.interact.onMouseOut, _this.interact);
        CoffeeGL.Context.mouseMove.add(_this.interact.onMouseMove, _this.interact);
        CoffeeGL.Context.mouseUp.add(_this.interact.onMouseUp, _this.interact);
        CoffeeGL.Context.mouseWheel.add(_this.interact.onMouseWheel, _this.interact);
        CoffeeGL.Context.touchSpread.add(_this.interact.onTouchSpread, _this.interact);
        CoffeeGL.Context.touchPinch.add(_this.interact.onTouchPinch, _this.interact);
        CoffeeGL.Context.mouseOver.add(_this.onMouseOver, _this);
        CoffeeGL.Context.mouseOut.add(_this.onMouseOut, _this);
        CoffeeGL.Context.mouseMove.add(_this.onMouseMove, _this);
        CoffeeGL.Context.mouseMove.del(_this.c.onMouseMove, _this.c);
        CoffeeGL.Context.mouseDown.del(_this.c.onMouseDown, _this.c);
        _this.screen_quad = new CoffeeGL.Node(new CoffeeGL.Quad());
        _this.screen_quad.viewportSize = new CoffeeGL.Vec2(CoffeeGL.Context.width, CoffeeGL.Context.height);
        _this.screen_quad.uRenderedTextureWidth = CoffeeGL.Context.width;
        _this.screen_quad.uRenderedTextureHeight = CoffeeGL.Context.height;
        _this.screen_quad.uSampler = 0;
        _this.screen_quad.uSamplerDepth = 1;
        _this.screen_quad.add(_this.o);
        return _this.ready = true;
      };
      this.loaded.addOnce(f, this);
      loadAssets(this, this.loaded, this.load_progress);
      date = new Date();
      this.top_node.add(this.c);
      this.pickable.add(this.c);
      this.depth_node.add(this.c);
      this.string_nodes.add(this.c);
      this.light = new CoffeeGL.Light.PointLight(new CoffeeGL.Vec3(0.0, 5.0, 15.0), new CoffeeGL.Colour.RGB(1.0, 1.0, 1.0));
      this.light2 = new CoffeeGL.Light.PointLight(new CoffeeGL.Vec3(0.0, -5.0, 20.0), new CoffeeGL.Colour.RGB(0.9, 1.0, 1.0));
      this.light3 = new CoffeeGL.Light.PointLight(new CoffeeGL.Vec3(-1.0, 5.0, -8.0), new CoffeeGL.Colour.RGB(0.9, 1.0, 1.0));
      this.top_node.add(this.light);
      this.top_node.add(this.light2);
      this.top_node.add(this.light3);
      GL.enable(GL.CULL_FACE);
      GL.cullFace(GL.BACK);
      GL.enable(GL.DEPTH_TEST);
      return this.c.zoom(0.25);
    };

    Equatorie.prototype.eotw = function() {
      if (this.interact.date.getTime() === 1356091200000) {
        if (!this._eotw) {
          alert("ITS THE END OF THE WORLD! Any calculations made today are not guaranteed accurate!");
        }
        this._eotw = true;
        return this.shader_background.setUniform3f("uColour", 1.0, 0.0, 0.0);
      } else {
        this._eotw = false;
        return this.shader_background.setUniform3f("uColour", 1.0, 1.0, 1.0);
      }
    };

    Equatorie.prototype.update = function(dt) {
      if (!this.ready) {
        return;
      }
      this.interact.update(dt);
      return this;
    };

    Equatorie.prototype.updatePhysics = function(data) {
      this.white_string.update(data.white);
      return this.black_string.update(data.black);
    };

    Equatorie.prototype.onPhysicsEvent = function(event) {
      switch (event.data.cmd) {
        case "physics":
          return this.updatePhysics(event.data.data);
        case "ping":
          return console.log("Physics Ping: " + event.data.data);
        default:
          break;
      }
    };

    Equatorie.prototype.draw = function() {
      var pixel;
      GL.clearColor(0.15, 0.15, 0.15, 1.0);
      GL.clear(GL.COLOR_BUFFER_BIT | GL.DEPTH_BUFFER_BIT);
      this.c.update(CoffeeGL.Context.width, CoffeeGL.Context.height);
      this.o.update(CoffeeGL.Context.width, CoffeeGL.Context.height);
      if (!this.ready) {
        return;
      }
      this.fbo_fxaa.bind();
      this.fbo_fxaa.clear();
      GL.disable(GL.DEPTH_TEST);
      this.shader_background.bind();
      this.eotw();
      this.backing.draw();
      this.shader_background.unbind();
      GL.enable(GL.DEPTH_TEST);
      this.top_node.draw();
      if (CoffeeGL.Context.profile.mobile) {
        GL.disable(GL.DEPTH_TEST);
      }
      GL.disable(GL.CULL_FACE);
      this.string_nodes.draw();
      GL.enable(GL.CULL_FACE);
      if (CoffeeGL.Context.profile.mobile) {
        GL.enable(GL.DEPTH_TEST);
      }
      this.fbo_fxaa.unbind();
      if (!CoffeeGL.Context.profile.mobile) {
        this.fbo_depth.bind();
        this.fbo_depth.clear();
        this.depth_node.draw();
        this.fbo_depth.unbind();
      }
      this.fbo_picking.bind();
      this.fbo_picking.clear();
      this.shader_picker.bind();
      this.pickable.draw();
      if (this.mp.y !== -1 && this.mp.x !== -1) {
        pixel = new Uint8Array(4);
        GL.readPixels(this.mp.x, this.fbo_picking.height - this.mp.y, 1, 1, GL.RGBA, GL.UNSIGNED_BYTE, pixel);
        this.interact.checkPicked(pixel);
      }
      this.shader_picker.unbind();
      this.fbo_picking.unbind();
      if (CoffeeGL.Context.profile.mobile || true) {
        this.fbo_fxaa.texture.bind();
        this.shader_fxaa.bind();
        this.screen_quad.draw();
        this.shader_fxaa.unbind();
        return this.fbo_fxaa.texture.unbind();
      } else {
        this.fbo_depth.texture.unit = 1;
        this.fbo_fxaa.bind();
        this.fbo_fxaa.texture.bind();
        this.fbo_depth.texture.bind();
        this.shader_ssao.bind();
        this.shader_ssao.setUniform1f("uNearPlane", this.c.near);
        this.shader_ssao.setUniform1f("uFarPlane", this.c.far);
        this.screen_quad.draw();
        this.shader_ssao.unbind();
        this.fbo_depth.texture.unbind();
        this.fbo_fxaa.texture.unbind();
        this.fbo_fxaa.unbind();
        this.fbo_fxaa.texture.bind();
        this.shader_fxaa.bind();
        this.screen_quad.draw();
        this.shader_fxaa.unbind();
        return this.fbo_fxaa.texture.unbind();
      }
    };

    Equatorie.prototype.onMouseMove = function(event) {
      this.mp.x = event.mouseX;
      return this.mp.y = event.mouseY;
    };

    Equatorie.prototype.onMouseOver = function(event) {
      this.mp.x = event.mouseX;
      return this.mp.y = event.mouseY;
    };

    Equatorie.prototype.onMouseOut = function(event) {
      this.mp.x = -1;
      return this.mp.y = -1;
    };

    Equatorie.prototype.resize = function(w, h) {
      this.fbo_picking.resize(w, h);
      this.fbo_fxaa.resize(w, h);
      if (!CoffeeGL.Context.profile.mobile) {
        this.fbo_depth.resize(w, h);
      }
      if (this.screen_quad != null) {
        this.screen_quad.viewportSize.x = w;
        this.screen_quad.viewportSize.y = h;
        this.screen_quad.uRenderedTextureWidth = w;
        return this.screen_quad.uRenderedTextureHeight = h;
      }
    };

    Equatorie.prototype._setTangents = function(geom) {
      var a, b, c, face, _i, _len, _ref, _ref1;
      _ref = geom.faces;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        face = _ref[_i];
        _ref1 = CoffeeGL.precomputeTangent(face.v[0].p, face.v[1].p, face.v[2].p, face.v[0].n, face.v[1].n, face.v[2].n, face.v[0].t, face.v[1].t, face.v[2].t), a = _ref1[0], b = _ref1[1], c = _ref1[2];
        face.v[0].tangent = a;
        face.v[1].tangent = b;
        face.v[2].tangent = c;
      }
      return this;
    };

    return Equatorie;

  })();

  eq = new Equatorie();

  cgl = new CoffeeGL.App('webgl-canvas', eq, eq.init, eq.draw, eq.update, window.notSupported);

}).call(this);
